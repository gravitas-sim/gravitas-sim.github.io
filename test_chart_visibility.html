<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chart Visibility Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #e0e0e0;
        }
        .test-section {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #444;
        }
        .test-button {
            background: #0066cc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .test-button:hover {
            background: #0052a3;
        }
        .test-results {
            background: #333;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .status.success {
            background: #2d5a2d;
            color: #90ee90;
        }
        .status.error {
            background: #5a2d2d;
            color: #ff6b6b;
        }
        .status.info {
            background: #2d2d5a;
            color: #90caf9;
        }
        h1, h2 {
            color: #fff;
        }
        .instructions {
            background: #3a3a3a;
            padding: 15px;
            border-radius: 4px;
            border-left: 4px solid #0066cc;
        }
        .step {
            background: #3a3a3a;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid #ffcc00;
        }
    </style>
</head>
<body>
    <h1>üìä Chart Visibility and Refresh Test</h1>
    
    <div class="instructions">
        <h3>Test Instructions:</h3>
        <ol>
            <li>Open the main simulation in another tab/window</li>
            <li>Select an object (star, planet, etc.)</li>
            <li>Run these tests to verify chart visibility and refresh functionality</li>
        </ol>
    </div>

    <div class="test-section">
        <h2>Test 1: Automatic Chart Initialization</h2>
        <p>Tests that the chart is automatically initialized when an object is selected.</p>
        <div class="step">
            <strong>Step 1:</strong> Select an object in the simulation, then run this test.
        </div>
        <button class="test-button" onclick="testAutomaticInitialization()">Test Automatic Initialization</button>
        <div id="autoInitResults" class="test-results"></div>
    </div>

    <div class="test-section">
        <h2>Test 2: Energy Tab Activation</h2>
        <p>Tests that the chart appears when the energy tab is clicked.</p>
        <div class="step">
            <strong>Step 2:</strong> Click the "Energy" tab in the object inspector, then run this test.
        </div>
        <button class="test-button" onclick="testEnergyTabActivation()">Test Energy Tab Activation</button>
        <div id="energyTabResults" class="test-results"></div>
    </div>

    <div class="test-section">
        <h2>Test 3: Refresh Button Functionality</h2>
        <p>Tests that the refresh button works correctly.</p>
        <div class="step">
            <strong>Step 3:</strong> Click the refresh button in the energy tab, then run this test.
        </div>
        <button class="test-button" onclick="testRefreshButton()">Test Refresh Button</button>
        <div id="refreshButtonResults" class="test-results"></div>
    </div>

    <div class="test-section">
        <h2>Test 4: Chart Data Availability</h2>
        <p>Tests that energy data is available and the chart displays it.</p>
        <button class="test-button" onclick="testChartData()">Test Chart Data</button>
        <div id="chartDataResults" class="test-results"></div>
    </div>

    <script>
        const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));
        
        const logResult = (elementId, message) => {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent += message + '\n';
                element.scrollTop = element.scrollHeight;
            }
            console.log(message);
        };

        const clearResults = (elementId) => {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = '';
            }
        };

        const showStatus = (message, type = 'info') => {
            const status = document.createElement('div');
            status.className = `status ${type}`;
            status.textContent = message;
            document.body.insertBefore(status, document.body.firstChild);
            setTimeout(() => status.remove(), 5000);
        };

        // Test 1: Automatic Chart Initialization
        async function testAutomaticInitialization() {
            clearResults('autoInitResults');
            logResult('autoInitResults', 'üîß Testing Automatic Chart Initialization...');
            
            try {
                // Check if simulation is available
                if (!window.state) {
                    throw new Error('Simulation not available. Please open the main simulation first.');
                }

                // Check if an object is selected
                if (!window.state.selectedObject) {
                    throw new Error('No object selected. Please select an object first.');
                }

                logResult('autoInitResults', `Selected object: ${window.state.selectedObject.type} (ID: ${window.state.selectedObject.object.id})`);

                // Check if energy tab elements exist
                const energyTab = document.querySelector('.inspector-tab[data-tab="energy"]');
                const energyTabContent = document.getElementById('energyTab');
                const energyChart = document.getElementById('energyChart');

                if (!energyTab) {
                    throw new Error('Energy tab not found');
                }
                if (!energyTabContent) {
                    throw new Error('Energy tab content not found');
                }

                logResult('autoInitResults', '‚úÖ Energy tab elements found');

                // Check if chart canvas exists
                if (!energyChart) {
                    logResult('autoInitResults', '‚ö†Ô∏è Energy chart canvas not found');
                } else {
                    logResult('autoInitResults', '‚úÖ Energy chart canvas found');
                    logResult('autoInitResults', `Chart dimensions: ${energyChart.width}x${energyChart.height}`);
                }

                // Check if chart is initialized
                if (typeof window.chartInitialized !== 'undefined') {
                    logResult('autoInitResults', `Chart initialized: ${window.chartInitialized}`);
                } else {
                    logResult('autoInitResults', '‚ö†Ô∏è Chart initialization status unknown');
                }

                // Check if refresh button exists
                const refreshButton = document.getElementById('refreshEnergyChart');
                if (refreshButton) {
                    logResult('autoInitResults', '‚úÖ Refresh button found');
                    logResult('autoInitResults', `Button text: ${refreshButton.textContent}`);
                    logResult('autoInitResults', `Button title: ${refreshButton.title}`);
                } else {
                    logResult('autoInitResults', '‚ö†Ô∏è Refresh button not found');
                }

                logResult('autoInitResults', '\n‚úÖ Automatic Initialization Test Completed');
                showStatus('Automatic Initialization Test Completed!', 'success');

            } catch (error) {
                logResult('autoInitResults', `‚ùå Error: ${error.message}`);
                showStatus(`Automatic Initialization Test Error: ${error.message}`, 'error');
            }
        }

        // Test 2: Energy Tab Activation
        async function testEnergyTabActivation() {
            clearResults('energyTabResults');
            logResult('energyTabResults', 'üìä Testing Energy Tab Activation...');
            
            try {
                // Check if energy tab is active
                const energyTab = document.querySelector('.inspector-tab[data-tab="energy"]');
                const detailsTab = document.querySelector('.inspector-tab[data-tab="details"]');
                const energyTabContent = document.getElementById('energyTab');
                const detailsTabContent = document.getElementById('detailsTab');

                if (!energyTab || !detailsTab || !energyTabContent || !detailsTabContent) {
                    throw new Error('Required tab elements not found');
                }

                logResult('energyTabResults', `Energy tab active: ${energyTab.classList.contains('active')}`);
                logResult('energyTabResults', `Details tab active: ${detailsTab.classList.contains('active')}`);
                logResult('energyTabResults', `Energy content visible: ${energyTabContent.classList.contains('active')}`);
                logResult('energyTabResults', `Details content visible: ${detailsTabContent.classList.contains('active')}`);

                // Check if chart is visible
                const energyChart = document.getElementById('energyChart');
                if (energyChart) {
                    const chartStyle = window.getComputedStyle(energyChart);
                    logResult('energyTabResults', `Chart display: ${chartStyle.display}`);
                    logResult('energyTabResults', `Chart visibility: ${chartStyle.visibility}`);
                    logResult('energyTabResults', `Chart opacity: ${chartStyle.opacity}`);
                }

                // Check if collecting message is shown
                const collectingMessage = document.querySelector('.collecting-message');
                if (collectingMessage) {
                    const messageStyle = window.getComputedStyle(collectingMessage);
                    logResult('energyTabResults', `Collecting message display: ${messageStyle.display}`);
                } else {
                    logResult('energyTabResults', 'No collecting message found');
                }

                logResult('energyTabResults', '\n‚úÖ Energy Tab Activation Test Completed');
                showStatus('Energy Tab Activation Test Completed!', 'success');

            } catch (error) {
                logResult('energyTabResults', `‚ùå Error: ${error.message}`);
                showStatus(`Energy Tab Activation Test Error: ${error.message}`, 'error');
            }
        }

        // Test 3: Refresh Button Functionality
        async function testRefreshButton() {
            clearResults('refreshButtonResults');
            logResult('refreshButtonResults', 'üîÑ Testing Refresh Button Functionality...');
            
            try {
                // Check if refresh button exists and is clickable
                const refreshButton = document.getElementById('refreshEnergyChart');
                if (!refreshButton) {
                    throw new Error('Refresh button not found');
                }

                logResult('refreshButtonResults', '‚úÖ Refresh button found');
                logResult('refreshButtonResults', `Button text: ${refreshButton.textContent}`);
                logResult('refreshButtonResults', `Button disabled: ${refreshButton.disabled}`);

                // Check button styling
                const buttonStyle = window.getComputedStyle(refreshButton);
                logResult('refreshButtonResults', `Button display: ${buttonStyle.display}`);
                logResult('refreshButtonResults', `Button pointer-events: ${buttonStyle.pointerEvents}`);

                // Check if click handler functions exist
                if (typeof window.handleRefreshChart === 'function') {
                    logResult('refreshButtonResults', '‚úÖ handleRefreshChart function exists');
                } else {
                    logResult('refreshButtonResults', '‚ö†Ô∏è handleRefreshChart function not found');
                }

                if (typeof window.updateEnergyChart === 'function') {
                    logResult('refreshButtonResults', '‚úÖ updateEnergyChart function exists');
                } else {
                    logResult('refreshButtonResults', '‚ö†Ô∏è updateEnergyChart function not found');
                }

                // Test if button is actually clickable
                const rect = refreshButton.getBoundingClientRect();
                logResult('refreshButtonResults', `Button position: (${rect.left}, ${rect.top})`);
                logResult('refreshButtonResults', `Button size: ${rect.width}x${rect.height}`);

                if (rect.width > 0 && rect.height > 0) {
                    logResult('refreshButtonResults', '‚úÖ Refresh button is visible and clickable');
                } else {
                    logResult('refreshButtonResults', '‚ö†Ô∏è Refresh button has zero size');
                }

                logResult('refreshButtonResults', '\n‚úÖ Refresh Button Test Completed');
                showStatus('Refresh Button Test Completed!', 'success');

            } catch (error) {
                logResult('refreshButtonResults', `‚ùå Error: ${error.message}`);
                showStatus(`Refresh Button Test Error: ${error.message}`, 'error');
            }
        }

        // Test 4: Chart Data Availability
        async function testChartData() {
            clearResults('chartDataResults');
            logResult('chartDataResults', 'üìà Testing Chart Data Availability...');
            
            try {
                // Check if an object is selected
                if (!window.state || !window.state.selectedObject) {
                    throw new Error('No object selected');
                }

                const objectId = window.state.selectedObject.object.id;
                logResult('chartDataResults', `Testing data for object ID: ${objectId}`);

                // Check if energy functions exist
                if (typeof window.getObjectEnergyHistory !== 'function') {
                    throw new Error('getObjectEnergyHistory function not available');
                }

                // Get energy history
                const energyHistory = window.getObjectEnergyHistory(objectId);
                logResult('chartDataResults', `Energy history points: ${energyHistory.length}`);

                if (energyHistory.length > 0) {
                    const latest = energyHistory[energyHistory.length - 1];
                    logResult('chartDataResults', '‚úÖ Energy data available');
                    logResult('chartDataResults', `Latest timestamp: ${latest.timestamp}`);
                    logResult('chartDataResults', `Latest KE: ${latest.ke.toExponential(2)} J`);
                    logResult('chartDataResults', `Latest PE: ${latest.pe.toExponential(2)} J`);
                    logResult('chartDataResults', `Latest Total: ${latest.total.toExponential(2)} J`);
                } else {
                    logResult('chartDataResults', '‚ö†Ô∏è No energy data available yet');
                    logResult('chartDataResults', 'This is normal for newly selected objects');
                }

                // Check if chart functions exist
                if (typeof window.updateChart === 'function') {
                    logResult('chartDataResults', '‚úÖ updateChart function available');
                } else {
                    logResult('chartDataResults', '‚ö†Ô∏è updateChart function not available');
                }

                if (typeof window.clearChart === 'function') {
                    logResult('chartDataResults', '‚úÖ clearChart function available');
                } else {
                    logResult('chartDataResults', '‚ö†Ô∏è clearChart function not available');
                }

                logResult('chartDataResults', '\n‚úÖ Chart Data Test Completed');
                showStatus('Chart Data Test Completed!', 'success');

            } catch (error) {
                logResult('chartDataResults', `‚ùå Error: ${error.message}`);
                showStatus(`Chart Data Test Error: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html> 