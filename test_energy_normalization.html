<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Energy Normalization Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #1a1a1a;
            color: #ffffff;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .pass {
            background-color: #2d5a2d;
            border: 1px solid #4a7c4a;
        }
        .fail {
            background-color: #5a2d2d;
            border: 1px solid #7c4a4a;
        }
        .info {
            background-color: #2d2d5a;
            border: 1px solid #4a4a7c;
        }
        .energy-display {
            font-family: monospace;
            background-color: #1a1a1a;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        button {
            background-color: #4a4a7c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #5a5a8c;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>Energy Normalization Test</h1>
        <p>This test verifies that the energy normalization is working correctly, ensuring that kinetic energy is approximately half the magnitude of potential energy (|PE| ‚âà 2 √ó KE) and that energies are displayed in reasonable Joules after applying a global 10^-45 scaling factor.</p>
        
        <button onclick="runTests()">Run Energy Normalization Tests</button>
        <button onclick="clearResults()">Clear Results</button>
        
        <div id="results"></div>
    </div>

    <script type="module">
        // Import physics functions
        import {
            calculateObjectEnergy,
            calculateKineticEnergy,
            calculateTotalPotentialEnergy,
            getAllPhysicsObjects
        } from './js/physics.js';

        // Make functions available globally for testing
        window.calculateObjectEnergy = calculateObjectEnergy;
        window.calculateKineticEnergy = calculateKineticEnergy;
        window.calculateTotalPotentialEnergy = calculateTotalPotentialEnergy;
        window.getAllPhysicsObjects = getAllPhysicsObjects;

        // Test data
        const testObjects = [
            {
                name: "Earth-like Planet",
                pos: { x: 100, y: 0 },
                vel: { x: 0, y: 10 },
                mass: 3, // 1 Earth mass
                radius: 5,
                id: 1,
                alive: true
            },
            {
                name: "Jupiter-like Gas Giant",
                pos: { x: 200, y: 0 },
                vel: { x: 0, y: 15 },
                mass: 150, // ~3 Jupiter masses
                radius: 8,
                id: 2,
                alive: true
            },
            {
                name: "Solar-mass Star",
                pos: { x: 0, y: 0 },
                vel: { x: 0, y: 0 },
                mass: 1000, // 1 solar mass
                radius: 10,
                id: 3,
                alive: true
            },
            {
                name: "Black Hole",
                pos: { x: 300, y: 0 },
                vel: { x: 0, y: 0 },
                mass: 2000, // 2 solar masses
                radius: 8,
                id: 4,
                alive: true
            }
        ];

        function displayResult(message, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${type}`;
            resultDiv.innerHTML = message;
            resultsDiv.appendChild(resultDiv);
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        function testEnergyNormalization() {
            displayResult('<h3>Testing Energy Normalization</h3>', 'info');
            
            let allTestsPassed = true;
            
            for (const testObj of testObjects) {
                displayResult(`<h4>Testing ${testObj.name}</h4>`, 'info');
                
                // Create a mock environment with the test object and a central mass
                const centralMass = {
                    pos: { x: 0, y: 0 },
                    vel: { x: 0, y: 0 },
                    mass: 1000,
                    radius: 10,
                    id: 999,
                    alive: true
                };
                
                // Mock getAllPhysicsObjects to return our test environment
                const originalGetAllPhysicsObjects = window.getAllPhysicsObjects;
                window.getAllPhysicsObjects = () => [testObj, centralMass];
                
                try {
                    // Calculate energy using the normalized function
                    const energy = window.calculateObjectEnergy(testObj, performance.now());
                    
                    // Display raw values
                    displayResult(`
                        <div class="energy-display">
                            <strong>Raw Energy Values:</strong><br>
                            Kinetic Energy: ${energy.ke.toExponential(3)} J<br>
                            Potential Energy: ${energy.pe.toExponential(3)} J<br>
                            Total Energy: ${energy.total.toExponential(3)} J
                        </div>
                    `, 'info');
                    
                    // Check if KE ‚âà 0.5 √ó |PE|
                    const expectedKE = Math.abs(energy.pe) * 0.5;
                    const keRatio = energy.ke / expectedKE;
                    const tolerance = 0.1; // 10% tolerance
                    
                    const isRatioCorrect = Math.abs(keRatio - 1.0) <= tolerance;
                    
                    if (isRatioCorrect) {
                        displayResult(`
                            <div class="test-result pass">
                                ‚úÖ PASS: KE ratio is ${keRatio.toFixed(3)} (expected ~1.0, tolerance ¬±${tolerance})
                            </div>
                        `, 'pass');
                    } else {
                        displayResult(`
                            <div class="test-result fail">
                                ‚ùå FAIL: KE ratio is ${keRatio.toFixed(3)} (expected ~1.0, tolerance ¬±${tolerance})
                            </div>
                        `, 'fail');
                        allTestsPassed = false;
                    }
                    
                    // Check if energies are in reasonable astrophysical ranges
                    // After 10^-45 scaling, energies should be in 10^-21 to 10^-13 J range
                    const isReasonableRange = energy.ke > 1e-21 && energy.ke < 1e-13 && 
                                            energy.pe < -1e-21 && energy.pe > -1e-13;
                    
                    if (isReasonableRange) {
                        displayResult(`
                            <div class="test-result pass">
                                ‚úÖ PASS: Energies are in reasonable astrophysical ranges (10^-21-10^-13 J)
                            </div>
                        `, 'pass');
                    } else {
                        displayResult(`
                            <div class="test-result fail">
                                ‚ùå FAIL: Energies are outside reasonable astrophysical ranges
                            </div>
                        `, 'fail');
                        allTestsPassed = false;
                    }
                    
                } catch (error) {
                    displayResult(`
                        <div class="test-result fail">
                            ‚ùå ERROR: ${error.message}
                        </div>
                    `, 'fail');
                    allTestsPassed = false;
                } finally {
                    // Restore original function
                    window.getAllPhysicsObjects = originalGetAllPhysicsObjects;
                }
                
                displayResult('<hr>', 'info');
            }
            
            // Overall result
            if (allTestsPassed) {
                displayResult(`
                    <div class="test-result pass">
                        <h3>üéâ All Energy Normalization Tests Passed!</h3>
                        <p>The energy normalization is working correctly. Kinetic energy is approximately half the magnitude of potential energy, and all values are in reasonable astrophysical ranges.</p>
                    </div>
                `, 'pass');
            } else {
                displayResult(`
                    <div class="test-result fail">
                        <h3>‚ùå Some Energy Normalization Tests Failed</h3>
                        <p>Please check the individual test results above for details.</p>
                    </div>
                `, 'fail');
            }
        }

        function runTests() {
            clearResults();
            
            // Check if required functions are available
            if (typeof window.calculateObjectEnergy !== 'function') {
                displayResult(`
                    <div class="test-result fail">
                        ‚ùå ERROR: calculateObjectEnergy function not available
                    </div>
                `, 'fail');
                return;
            }
            
            if (typeof window.calculateKineticEnergy !== 'function') {
                displayResult(`
                    <div class="test-result fail">
                        ‚ùå ERROR: calculateKineticEnergy function not available
                    </div>
                `, 'fail');
                return;
            }
            
            if (typeof window.calculateTotalPotentialEnergy !== 'function') {
                displayResult(`
                    <div class="test-result fail">
                        ‚ùå ERROR: calculateTotalPotentialEnergy function not available
                    </div>
                `, 'fail');
                return;
            }
            
            displayResult(`
                <div class="test-result info">
                    ‚úÖ All required functions are available. Starting tests...
                </div>
            `, 'info');
            
            // Run the tests
            testEnergyNormalization();
        }

        // Make test function available globally
        window.runTests = runTests;
        window.clearResults = clearResults;
    </script>
</body>
</html> 