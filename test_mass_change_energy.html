<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mass Change Energy Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #1a1a1a;
            color: #e0e0e0;
        }
        .test-section {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #444;
        }
        .test-button {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #45a049;
        }
        .test-button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid #4CAF50;
        }
        .error {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid #f44336;
        }
        .info {
            background: rgba(33, 150, 243, 0.2);
            border: 1px solid #2196F3;
        }
        .log {
            background: #333;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>Mass Change Energy Test</h1>
    <p>This test verifies that energy history is properly cleared when object mass changes.</p>

    <div class="test-section">
        <h2>Test 1: Mass Change Energy History Clearing</h2>
        <p>This test verifies that when an object's mass is changed, its energy history is cleared and the chart resets.</p>
        <button class="test-button" onclick="testMassChangeEnergyClearing()">Run Mass Change Test</button>
        <div id="test1-result"></div>
    </div>

    <div class="test-section">
        <h2>Test 2: Energy Chart Reset Verification</h2>
        <p>This test verifies that the energy chart is cleared and shows "Collecting data..." when mass changes.</p>
        <button class="test-button" onclick="testEnergyChartReset()">Run Chart Reset Test</button>
        <div id="test2-result"></div>
    </div>

    <div class="test-section">
        <h2>Test 3: Multiple Mass Changes</h2>
        <p>This test verifies that energy history is cleared on each mass change, not just the first one.</p>
        <button class="test-button" onclick="testMultipleMassChanges()">Run Multiple Changes Test</button>
        <div id="test3-result"></div>
    </div>

    <div class="test-section">
        <h2>Test Log</h2>
        <div id="test-log" class="log"></div>
        <button class="test-button" onclick="clearLog()">Clear Log</button>
    </div>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('test-log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.style.color = type === 'error' ? '#f44336' : type === 'success' ? '#4CAF50' : '#e0e0e0';
            logEntry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function clearLog() {
            document.getElementById('test-log').innerHTML = '';
        }

        function showResult(testId, message, type = 'info') {
            const resultDiv = document.getElementById(`${testId}-result`);
            resultDiv.innerHTML = `<div class="result ${type}">${message}</div>`;
        }

        function testMassChangeEnergyClearing() {
            log('Starting mass change energy clearing test...', 'info');
            
            try {
                // Check if simulation is available
                if (typeof window.state === 'undefined') {
                    throw new Error('Simulation state not available');
                }

                // Check if energy functions are available
                if (typeof window.clearObjectEnergyHistory === 'undefined') {
                    throw new Error('clearObjectEnergyHistory function not available');
                }

                // Get a test object (preferably a star)
                const objects = window.getAllPhysicsObjects ? window.getAllPhysicsObjects() : [];
                const testObject = objects.find(obj => obj && obj.mass && obj.id);
                
                if (!testObject) {
                    throw new Error('No suitable test object found');
                }

                log(`Found test object: ${testObject.name || 'Unknown'} (ID: ${testObject.id})`, 'info');

                // Get initial energy history
                const initialHistory = window.getObjectEnergyHistory ? window.getObjectEnergyHistory(testObject.id) : [];
                log(`Initial energy history length: ${initialHistory.length}`, 'info');

                // Simulate mass change by calling clearObjectEnergyHistory
                const oldMass = testObject.mass;
                log(`Object mass before change: ${oldMass}`, 'info');
                
                window.clearObjectEnergyHistory(testObject.id);
                log('Energy history cleared', 'success');

                // Get energy history after clearing
                const clearedHistory = window.getObjectEnergyHistory ? window.getObjectEnergyHistory(testObject.id) : [];
                log(`Energy history length after clearing: ${clearedHistory.length}`, 'info');

                // Verify history is empty
                if (clearedHistory.length === 0) {
                    log('✅ Energy history successfully cleared', 'success');
                    showResult('test1', '✅ PASS: Energy history is properly cleared when mass changes', 'success');
                } else {
                    throw new Error(`Energy history not cleared properly. Expected 0, got ${clearedHistory.length}`);
                }

            } catch (error) {
                log(`❌ Error: ${error.message}`, 'error');
                showResult('test1', `❌ FAIL: ${error.message}`, 'error');
            }
        }

        function testEnergyChartReset() {
            log('Starting energy chart reset test...', 'info');
            
            try {
                // Check if chart functions are available
                if (typeof window.clearChart === 'undefined') {
                    throw new Error('clearChart function not available');
                }

                // Check if collecting message functions are available
                if (typeof window.showCollectingMessage === 'undefined') {
                    throw new Error('showCollectingMessage function not available');
                }

                // Simulate chart clearing
                log('Clearing energy chart...', 'info');
                window.clearChart();
                log('Chart cleared', 'success');

                // Check if collecting message can be shown
                log('Showing collecting message...', 'info');
                window.showCollectingMessage();
                log('Collecting message shown', 'success');

                // Check if collecting message element exists
                const collectingMessage = document.querySelector('.collecting-message');
                if (collectingMessage) {
                    log('✅ Collecting message element found', 'success');
                    showResult('test2', '✅ PASS: Energy chart properly resets and shows collecting message', 'success');
                } else {
                    log('⚠️ Collecting message element not found (may be normal if no object is selected)', 'info');
                    showResult('test2', '⚠️ PARTIAL: Chart clearing works, but collecting message not visible (may be normal)', 'info');
                }

            } catch (error) {
                log(`❌ Error: ${error.message}`, 'error');
                showResult('test2', `❌ FAIL: ${error.message}`, 'error');
            }
        }

        function testMultipleMassChanges() {
            log('Starting multiple mass changes test...', 'info');
            
            try {
                // Check if simulation is available
                if (typeof window.state === 'undefined') {
                    throw new Error('Simulation state not available');
                }

                // Get a test object
                const objects = window.getAllPhysicsObjects ? window.getAllPhysicsObjects() : [];
                const testObject = objects.find(obj => obj && obj.mass && obj.id);
                
                if (!testObject) {
                    throw new Error('No suitable test object found');
                }

                log(`Testing multiple mass changes on object: ${testObject.name || 'Unknown'} (ID: ${testObject.id})`, 'info');

                // Test multiple mass changes
                for (let i = 1; i <= 3; i++) {
                    log(`Mass change ${i}: Clearing energy history...`, 'info');
                    window.clearObjectEnergyHistory(testObject.id);
                    
                    const history = window.getObjectEnergyHistory ? window.getObjectEnergyHistory(testObject.id) : [];
                    log(`After change ${i}: Energy history length = ${history.length}`, 'info');
                    
                    if (history.length !== 0) {
                        throw new Error(`Energy history not cleared on change ${i}. Expected 0, got ${history.length}`);
                    }
                }

                log('✅ All multiple mass changes successfully cleared energy history', 'success');
                showResult('test3', '✅ PASS: Energy history is cleared on each mass change', 'success');

            } catch (error) {
                log(`❌ Error: ${error.message}`, 'error');
                showResult('test3', `❌ FAIL: ${error.message}`, 'error');
            }
        }

        // Auto-run basic availability check when page loads
        window.addEventListener('load', () => {
            log('Page loaded, checking for required functions...', 'info');
            
            const requiredFunctions = [
                'clearObjectEnergyHistory',
                'getObjectEnergyHistory',
                'clearChart',
                'showCollectingMessage'
            ];

            let allAvailable = true;
            requiredFunctions.forEach(funcName => {
                if (typeof window[funcName] === 'undefined') {
                    log(`❌ Missing function: ${funcName}`, 'error');
                    allAvailable = false;
                } else {
                    log(`✅ Available: ${funcName}`, 'success');
                }
            });

            if (allAvailable) {
                log('✅ All required functions are available', 'success');
            } else {
                log('❌ Some required functions are missing. Tests may fail.', 'error');
            }
        });
    </script>
</body>
</html> 